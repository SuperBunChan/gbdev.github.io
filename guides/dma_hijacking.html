<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.32">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png"><title>DMA Hijacking | gbdev</title><meta name="description" content="game boy development scene">
    <link rel="modulepreload" href="/assets/app.1a57bdf1.js"><link rel="modulepreload" href="/assets/dma_hijacking.html.33922fb6.js"><link rel="modulepreload" href="/assets/plugin-vue_export-helper.21dcd24c.js"><link rel="modulepreload" href="/assets/dma_hijacking.html.bc58eec4.js">
    <link rel="stylesheet" href="/assets/style.7476d0f4.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name">gbdev</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://www.patreon.com/gbdev01" rel="noopener noreferrer" target="_blank" aria-label="Patreon"><!--[--><!--]--> Patreon <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://opencollective.com/gbdev/" rel="noopener noreferrer" target="_blank" aria-label="OpenCollective"><!--[--><!--]--> OpenCollective <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://www.patreon.com/gbdev01" rel="noopener noreferrer" target="_blank" aria-label="Patreon"><!--[--><!--]--> Patreon <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="navbar-item"><a class="external-link" href="https://opencollective.com/gbdev/" rel="noopener noreferrer" target="_blank" aria-label="OpenCollective"><!--[--><!--]--> OpenCollective <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><a href="/" class="sidebar-item sidebar-heading" aria-label="Community"><!--[--><!--]--> Community <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/chat" class="sidebar-item" aria-label="Chat"><!--[--><!--]--> Chat <!--[--><!--]--></a><!----></li><li><a href="/contribute" class="sidebar-item" aria-label="Contribute"><!--[--><!--]--> Contribute <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/list" class="sidebar-item sidebar-heading" aria-label="Resources"><!--[--><!--]--> Resources <!--[--><!--]--></a><!----></li><li><p class="sidebar-item sidebar-heading active">Guides <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/guides/tools" class="sidebar-item" aria-label="Choosing development tools"><!--[--><!--]--> Choosing development tools <!--[--><!--]--></a><!----></li><li><a href="/guides/asmstyle" class="sidebar-item" aria-label="ASM Style recomendations"><!--[--><!--]--> ASM Style recomendations <!--[--><!--]--></a><!----></li><li><a href="/guides/lyc_timing" class="sidebar-item" aria-label="The Timing of LYC STAT Handlers"><!--[--><!--]--> The Timing of LYC STAT Handlers <!--[--><!--]--></a><!----></li><li><a href="/guides/deadcscroll" class="sidebar-item" aria-label="Dead C Scroll"><!--[--><!--]--> Dead C Scroll <!--[--><!--]--></a><!----></li><li><a href="/guides/dma_hijacking" class="router-link-active sidebar-item active" aria-label="DMA Hijacking"><!--[--><!--]--> DMA Hijacking <!--[--><!--]--></a><!----></li><li><a class="external-link sidebar-item" href="https://eldred.fr/gb-asm-tutorial" rel="noopener noreferrer" target="_blank" aria-label="GB ASM Programming Guide"><!--[--><!--]--> GB ASM Programming Guide <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/gbcompo21" class="sidebar-item sidebar-heading" aria-label="GB Competition 2021"><!--[--><!--]--> GB Competition 2021 <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/gbcompo21-results" class="sidebar-item" aria-label="Results"><!--[--><!--]--> Results <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="dma-hijacking" tabindex="-1"><a class="header-anchor" href="#dma-hijacking" aria-hidden="true">#</a> DMA Hijacking</h1><p>Written by <a href="https://github.com/ISSOtm" target="_blank" rel="noopener noreferrer">ISSOtm<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>.</p><hr><h2 id="what-is-this" tabindex="-1"><a class="header-anchor" href="#what-is-this" aria-hidden="true">#</a> What is this ?</h2><p>It&#39;s a simple technique that allows you to run custom code in most GB/SGB/CGB games, provided you have an ACE exploit.</p><p>What&#39;s the point, then? It&#39;s that code ran through DMA Hijacking will be run on every game frame (for most games, at least).</p><h2 id="how-is-it-done" tabindex="-1"><a class="header-anchor" href="#how-is-it-done" aria-hidden="true">#</a> How is it done ?</h2><p>If you are familiar enough with OAM, you know about that feature called <em>OAM DMA</em> that requires a small routine to be ran in HRAM ?</p><p>Well, most games copy the routine when starting up and run it on every frame. I encountered some games which don&#39;t transfer OAM unless a specific flag is set ; I believe that it is always possible to override this limitation. more on that later.</p><p>But if the routine is modified while the game is running - assuming you modify it fully in-between to VBlanks to prevent a crash, or you temporarily put a RET while modifying - then the game will happily run your custom routine.</p><p>Here is the standard routine, given by Nintendo in the GB programming manual :</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#D8DEE9FF;">ld a, OAMBuffer &gt;&gt; </span><span style="color:#B48EAD;">8</span></span>
<span class="line"><span style="color:#D8DEE9FF;">ldh [$FF46], a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">ld a, </span><span style="color:#B48EAD;">$28</span></span>
<span class="line"><span style="color:#88C0D0;">DMALoop</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#81A1C1;">dec</span><span style="color:#D8DEE9FF;"> a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">jr nz, DMALoop</span></span>
<span class="line"><span style="color:#81A1C1;">ret</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>It&#39;s usually placed right at <code>$FF80</code>, but this isn&#39;t true for every game. Now, overwriting the routine to place custom code would yield us 10 bytes to perform custom operations, at the cost of sprites. But we can do better.</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#81A1C1;">call</span><span style="color:#D8DEE9FF;"> DMAHook</span></span>
<span class="line"><span style="color:#D8DEE9FF;">ldh [$FF00+c], a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">ld a, </span><span style="color:#B48EAD;">$28</span></span>
<span class="line"><span style="color:#88C0D0;">DMALoop</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#81A1C1;">dec</span><span style="color:#D8DEE9FF;"> a</span></span>
<span class="line"><span style="color:#D8DEE9FF;">jr nz, DMALoop</span></span>
<span class="line"><span style="color:#81A1C1;">ret</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>Allows us to make the perfect compromise ! Here is a pattern for DMAHook :</p><div class="language-asm ext-asm line-numbers-mode"><pre class="shiki" style="background-color:#2e3440ff;"><code><span class="line"><span style="color:#88C0D0;">DMAHook</span><span style="color:#ECEFF4;">:</span></span>
<span class="line"><span style="color:#D8DEE9FF;">[ custom code, </span><span style="color:#81A1C1;">do</span><span style="color:#D8DEE9FF;"> whatever you want, it&#39;s VBlank time ! ]</span></span>
<span class="line"><span style="color:#D8DEE9FF;">ld c, </span><span style="color:#B48EAD;">$46</span></span>
<span class="line"><span style="color:#D8DEE9FF;">ld a, OAMBuffer &gt;&gt; </span><span style="color:#B48EAD;">8</span></span>
<span class="line"><span style="color:#81A1C1;">ret</span></span>
<span class="line"></span></code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>DMAHook can be anywhere (in WRAM, mostly). It will be executed in the context of the VBlank interrupt, so for most games interrupts will be disabled, etc. An alert reader will notice the new DMA handler modifies C (whereas the original simply zeroes A). I don&#39;t know any game whose behavior is altered by this.</p><p>DMA hijacking is also useful when combined with <a href="https://gist.github.com/ISSOtm/3008fd73ec66cb56f1caecfcc8b6fb6f" target="_blank" rel="noopener noreferrer">cartswap<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> (swapping carts without shutting the console down, concept found by furrtek, developed by Cryo and me on the GCL forums), because it allows porting ACE to other games.</p><p>General procedure :</p><ul><li>Acquire ACE in the donor game</li><li>Perform cartswap, insert the recipient game</li><li>Pseudo-initialize the recipient (clear enough memory to avoid crashing, while keeping our custom code in an unused region of memory we don&#39;t clear)</li><li>Place the modified DMA handler in HRAM</li><li>Transfer control back to the recipient&#39;s ROM</li><li>????</li><li>Profit.</li></ul><p><a href="http://youtu.be/BNyDmZlbsNI" target="_blank" rel="noopener noreferrer">Video demonstration, performed by Torchickens/ChickasaurusGL in BGB<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a></p><p>Possible applications are checking for a button combo to trigger specific code (for example, credits warp), checking one or multiple memory addresses to detect a certain game state, etc.</p><p>Possible &quot;attack vectors&quot;, ie ways of affecting the recipient game, are setting certain memory addresses (like GameShark), or even better : manipulating the stack.</p><p>Manipulating the stack with this technique can not crash if the triggering game state is specific enough. I achieved text pointer manipulation in Pokémon Red this way.</p><h3 id="details" tabindex="-1"><a class="header-anchor" href="#details" aria-hidden="true">#</a> Details</h3><p>Here are some details on how to combine DMA hijacking and cartswap to pwn any game.</p><p>First thing you will need is to find some RAM to store the DMA hook code. We&#39;ll call it &quot;HookRAM&quot;. I recommend checking how much memory is allocated to the stack.</p><p>Then :</p><ul><li>Clear as much RAM as needed for the game to run properly</li><li>Copy the DMA hook code to HookRAM</li><li>Copy the hijacked DMA routine to HRAM</li><li>Emulate all game initialization up to right before DMA routine copy / HookRAM clearing</li><li>Jump back to ROM</li></ul><h2 id="trivia" tabindex="-1"><a class="header-anchor" href="#trivia" aria-hidden="true">#</a> Trivia</h2><p>DMA hijacking works similarly to the GameShark : it detected when the GB tried reading from the VBlank interrupt vector, and responded with instructions that applied the codes.</p><p>And yep, it is possible to use DMA hijacking to emulate GameShark codes. I have a PoC in Pokémon Red (a BGB save state), if anyone&#39;s interested.</p><p><a href="http://gbdev.gg8.se/forums/viewtopic.php?id=430" target="_blank" rel="noopener noreferrer">Demo video<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a>.</p><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><!----></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.1a57bdf1.js" defer></script>
  </body>
</html>
