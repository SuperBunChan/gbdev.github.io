<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>DMA Hijacking | gbdev</title>
    <meta name="generator" content="VuePress 1.9.5">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicons/favicon-16x16.png">
    <meta name="description" content="game boy development scene">
    
    <link rel="preload" href="/assets/css/0.styles.0d08ecc1.css" as="style"><link rel="preload" href="/assets/js/app.f0aa53b2.js" as="script"><link rel="preload" href="/assets/js/2.6fbdccb0.js" as="script"><link rel="preload" href="/assets/js/11.daafacaf.js" as="script"><link rel="prefetch" href="/assets/js/10.be381c7f.js"><link rel="prefetch" href="/assets/js/12.aca2751d.js"><link rel="prefetch" href="/assets/js/13.b4eed656.js"><link rel="prefetch" href="/assets/js/14.506f9f2c.js"><link rel="prefetch" href="/assets/js/3.7fa11fee.js"><link rel="prefetch" href="/assets/js/4.e736071f.js"><link rel="prefetch" href="/assets/js/5.08883d59.js"><link rel="prefetch" href="/assets/js/6.12e7021b.js"><link rel="prefetch" href="/assets/js/7.2d05821b.js"><link rel="prefetch" href="/assets/js/8.b6161b87.js"><link rel="prefetch" href="/assets/js/9.2563e267.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0d08ecc1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">gbdev</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span></span> <span class="arrow down"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span></span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span></span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span></span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span></span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span></span> <span class="arrow down"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span></span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span></span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span></span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span></span> <span class="arrow right"></span></p> <!----></section></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="dma-hijacking"><a href="#dma-hijacking" class="header-anchor">#</a> DMA Hijacking</h1> <p>Written by <a href="https://github.com/ISSOtm" target="_blank" rel="noopener noreferrer">ISSOtm<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p> <hr> <h2 id="what-is-this"><a href="#what-is-this" class="header-anchor">#</a> What is this ?</h2> <p>It's a simple technique that allows you to run custom code in most GB/SGB/CGB games, provided you have an ACE exploit.</p> <p>What's the point, then? It's that code ran through DMA Hijacking will be run on every game frame (for most games, at least).</p> <h2 id="how-is-it-done"><a href="#how-is-it-done" class="header-anchor">#</a> How is it done ?</h2> <p>If you are familiar enough with OAM, you know about that feature called <em>OAM DMA</em> that requires a small routine to be ran in HRAM ?</p> <p>Well, most games copy the routine when starting up and run it on every frame. I encountered some games which don't transfer OAM unless a specific flag is set ; I believe that it is always possible to override this limitation. more on that later.</p> <p>But if the routine is modified while the game is running - assuming you modify it fully in-between to VBlanks to prevent a crash, or you temporarily put a RET while modifying - then the game will happily run your custom routine.</p> <p>Here is the standard routine, given by Nintendo in the GB programming manual :</p> <div class="language-asm extra-class"><pre class="language-text"><code>ld a, OAMBuffer &gt;&gt; 8
ldh [$FF46], a
ld a, $28
DMALoop:
dec a
jr nz, DMALoop
ret
</code></pre></div><p>It's usually placed right at <code>$FF80</code>, but this isn't true for every game.
Now, overwriting the routine to place custom code would yield us 10 bytes to perform custom operations, at the cost of sprites.
But we can do better.</p> <div class="language-asm extra-class"><pre class="language-text"><code>call DMAHook
ldh [$FF00+c], a
ld a, $28
DMALoop:
dec a
jr nz, DMALoop
ret
</code></pre></div><p>Allows us to make the perfect compromise !
Here is a pattern for DMAHook :</p> <div class="language-asm extra-class"><pre class="language-text"><code>DMAHook:
[ custom code, do whatever you want, it's VBlank time ! ]
ld c, $46
ld a, OAMBuffer &gt;&gt; 8
ret
</code></pre></div><p>DMAHook can be anywhere (in WRAM, mostly). It will be executed in the context of the VBlank interrupt, so for most games interrupts will be disabled, etc.
An alert reader will notice the new DMA handler modifies C (whereas the original simply zeroes A). I don't know any game whose behavior is altered by this.</p> <p>DMA hijacking is also useful when combined with <a href="https://gist.github.com/ISSOtm/3008fd73ec66cb56f1caecfcc8b6fb6f" target="_blank" rel="noopener noreferrer">cartswap<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a> (swapping carts without shutting the console down, concept found by furrtek, developed by Cryo and me on the GCL forums), because it allows porting ACE to other games.</p> <p>General procedure :</p> <ul><li>Acquire ACE in the donor game</li> <li>Perform cartswap, insert the recipient game</li> <li>Pseudo-initialize the recipient (clear enough memory to avoid crashing, while keeping our custom code in an unused region of memory we don't clear)</li> <li>Place the modified DMA handler in HRAM</li> <li>Transfer control back to the recipient's ROM</li> <li>????</li> <li>Profit.</li></ul> <p><a href="http://youtu.be/BNyDmZlbsNI" target="_blank" rel="noopener noreferrer">Video demonstration, performed by Torchickens/ChickasaurusGL in BGB<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Possible applications are checking for a button combo to trigger specific code (for example, credits warp), checking one or multiple memory addresses to detect a certain game state, etc.</p> <p>Possible &quot;attack vectors&quot;, ie ways of affecting the recipient game, are setting certain memory addresses (like GameShark), or even better : manipulating the stack.</p> <p>Manipulating the stack with this technique can not crash if the triggering game state is specific enough. I achieved text pointer manipulation in Pok√©mon Red this way.</p> <h3 id="details"><a href="#details" class="header-anchor">#</a> Details</h3> <p>Here are some details on how to combine DMA hijacking and cartswap to pwn any game.</p> <p>First thing you will need is to find some RAM to store the DMA hook code. We'll call it &quot;HookRAM&quot;. I recommend checking how much memory is allocated to the stack.</p> <p>Then :</p> <ul><li>Clear as much RAM as needed for the game to run properly</li> <li>Copy the DMA hook code to HookRAM</li> <li>Copy the hijacked DMA routine to HRAM</li> <li>Emulate all game initialization up to right before DMA routine copy / HookRAM clearing</li> <li>Jump back to ROM</li></ul> <h2 id="trivia"><a href="#trivia" class="header-anchor">#</a> Trivia</h2> <p>DMA hijacking works similarly to the GameShark : it detected when the GB tried reading from the VBlank interrupt vector, and responded with instructions that applied the codes.</p> <p>And yep, it is possible to use DMA hijacking to emulate GameShark codes. I have a PoC in Pok√©mon Red (a BGB save state), if anyone's interested.</p> <p><a href="http://gbdev.gg8.se/forums/viewtopic.php?id=430" target="_blank" rel="noopener noreferrer">Demo video<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>.</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.f0aa53b2.js" defer></script><script src="/assets/js/2.6fbdccb0.js" defer></script><script src="/assets/js/11.daafacaf.js" defer></script>
  </body>
</html>
