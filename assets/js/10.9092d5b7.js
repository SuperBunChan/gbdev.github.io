(window.webpackJsonp=window.webpackJsonp||[]).push([[10],{396:function(e,t,a){"use strict";a.r(t);var i=a(52),o=Object(i.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"dma-hijacking"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dma-hijacking"}},[e._v("#")]),e._v(" DMA Hijacking")]),e._v(" "),a("p",[e._v("Written by "),a("a",{attrs:{href:"https://github.com/ISSOtm",target:"_blank",rel:"noopener noreferrer"}},[e._v("ISSOtm"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("hr"),e._v(" "),a("h2",{attrs:{id:"what-is-this"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#what-is-this"}},[e._v("#")]),e._v(" What is this ?")]),e._v(" "),a("p",[e._v("It's a simple technique that allows you to run custom code in most GB/SGB/CGB games, provided you have an ACE exploit.")]),e._v(" "),a("p",[e._v("What's the point, then? It's that code ran through DMA Hijacking will be run on every game frame (for most games, at least).")]),e._v(" "),a("h2",{attrs:{id:"how-is-it-done"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#how-is-it-done"}},[e._v("#")]),e._v(" How is it done ?")]),e._v(" "),a("p",[e._v("If you are familiar enough with OAM, you know about that feature called "),a("em",[e._v("OAM DMA")]),e._v(" that requires a small routine to be ran in HRAM ?")]),e._v(" "),a("p",[e._v("Well, most games copy the routine when starting up and run it on every frame. I encountered some games which don't transfer OAM unless a specific flag is set ; I believe that it is always possible to override this limitation. more on that later.")]),e._v(" "),a("p",[e._v("But if the routine is modified while the game is running - assuming you modify it fully in-between to VBlanks to prevent a crash, or you temporarily put a RET while modifying - then the game will happily run your custom routine.")]),e._v(" "),a("p",[e._v("Here is the standard routine, given by Nintendo in the GB programming manual :")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("ld a, OAMBuffer >> 8\nldh [$FF46], a\nld a, $28\nDMALoop:\ndec a\njr nz, DMALoop\nret\n")])])]),a("p",[e._v("It's usually placed right at "),a("code",[e._v("$FF80")]),e._v(", but this isn't true for every game.\nNow, overwriting the routine to place custom code would yield us 10 bytes to perform custom operations, at the cost of sprites.\nBut we can do better.")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("call DMAHook\nldh [$FF00+c], a\nld a, $28\nDMALoop:\ndec a\njr nz, DMALoop\nret\n")])])]),a("p",[e._v("Allows us to make the perfect compromise !\nHere is a pattern for DMAHook :")]),e._v(" "),a("div",{staticClass:"language- extra-class"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[e._v("DMAHook:\n[ custom code, do whatever you want, it's VBlank time ! ]\nld c, $46\nld a, OAMBuffer >> 8\nret\n")])])]),a("p",[e._v("DMAHook can be anywhere (in WRAM, mostly). It will be executed in the context of the VBlank interrupt, so for most games interrupts will be disabled, etc.\nAn alert reader will notice the new DMA handler modifies C (whereas the original simply zeroes A). I don't know any game whose behavior is altered by this.")]),e._v(" "),a("p",[e._v("DMA hijacking is also useful when combined with "),a("a",{attrs:{href:"https://gist.github.com/ISSOtm/3008fd73ec66cb56f1caecfcc8b6fb6f",target:"_blank",rel:"noopener noreferrer"}},[e._v("cartswap"),a("OutboundLink")],1),e._v(" (swapping carts without shutting the console down, concept found by furrtek, developed by Cryo and me on the GCL forums), because it allows porting ACE to other games.")]),e._v(" "),a("p",[e._v("General procedure :")]),e._v(" "),a("ul",[a("li",[e._v("Acquire ACE in the donor game")]),e._v(" "),a("li",[e._v("Perform cartswap, insert the recipient game")]),e._v(" "),a("li",[e._v("Pseudo-initialize the recipient (clear enough memory to avoid crashing, while keeping our custom code in an unused region of memory we don't clear)")]),e._v(" "),a("li",[e._v("Place the modified DMA handler in HRAM")]),e._v(" "),a("li",[e._v("Transfer control back to the recipient's ROM")]),e._v(" "),a("li",[e._v("????")]),e._v(" "),a("li",[e._v("Profit.")])]),e._v(" "),a("p",[a("a",{attrs:{href:"http://youtu.be/BNyDmZlbsNI",target:"_blank",rel:"noopener noreferrer"}},[e._v("Video demonstration, performed by Torchickens/ChickasaurusGL in BGB"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("Possible applications are checking for a button combo to trigger specific code (for example, credits warp), checking one or multiple memory addresses to detect a certain game state, etc.")]),e._v(" "),a("p",[e._v('Possible "attack vectors", ie ways of affecting the recipient game, are setting certain memory addresses (like GameShark), or even better : manipulating the stack.')]),e._v(" "),a("p",[e._v("Manipulating the stack with this technique can not crash if the triggering game state is specific enough. I achieved text pointer manipulation in Pokémon Red this way.")]),e._v(" "),a("h3",{attrs:{id:"details"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#details"}},[e._v("#")]),e._v(" Details")]),e._v(" "),a("p",[e._v("Here are some details on how to combine DMA hijacking and cartswap to pwn any game.")]),e._v(" "),a("p",[e._v('First thing you will need is to find some RAM to store the DMA hook code. We\'ll call it "HookRAM". I recommend checking how much memory is allocated to the stack.')]),e._v(" "),a("p",[e._v("Then :")]),e._v(" "),a("ul",[a("li",[e._v("Clear as much RAM as needed for the game to run properly")]),e._v(" "),a("li",[e._v("Copy the DMA hook code to HookRAM")]),e._v(" "),a("li",[e._v("Copy the hijacked DMA routine to HRAM")]),e._v(" "),a("li",[e._v("Emulate all game initialization up to right before DMA routine copy / HookRAM clearing")]),e._v(" "),a("li",[e._v("Jump back to ROM")])]),e._v(" "),a("h2",{attrs:{id:"trivia"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#trivia"}},[e._v("#")]),e._v(" Trivia")]),e._v(" "),a("p",[e._v("DMA hijacking works similarly to the GameShark : it detected when the GB tried reading from the VBlank interrupt vector, and responded with instructions that applied the codes.")]),e._v(" "),a("p",[e._v("And yep, it is possible to use DMA hijacking to emulate GameShark codes. I have a PoC in Pokémon Red (a BGB save state), if anyone's interested.")]),e._v(" "),a("p",[a("a",{attrs:{href:"http://gbdev.gg8.se/forums/viewtopic.php?id=430",target:"_blank",rel:"noopener noreferrer"}},[e._v("Demo video"),a("OutboundLink")],1),e._v(".")])])}),[],!1,null,null,null);t.default=o.exports}}]);